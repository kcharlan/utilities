services:
  web:
    image: nginx:1.27-alpine
    depends_on: [index, app_py, app_node]
    ports:
      - "127.0.0.1:7711:80"
    volumes:
      - /Users/${USER}/webroot:/usr/share/nginx/html:ro
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    restart: unless-stopped

  index:
    image: node:24-alpine
    working_dir: /srv
    entrypoint: sh -c "npm install -g npm@11.7.0 && npm install --omit=dev --no-package-lock && node server.js"
    environment:
      CONFIG_ROOT: /mnt/config
      WEBROOT: /mnt/webroot
    volumes:
      - ./index:/srv:ro
      - index_node_modules:/srv/node_modules
      - /Users/${USER}/webroot:/mnt/webroot:ro
      - /Users/${USER}/webroot/.webserver:/mnt/config
    expose: ["3000"]
    restart: unless-stopped
  app_py:
    build: ./app_py
    # environment:
    #   MODULE_NAME: main
    #   VARIABLE_NAME: app
    volumes:
      - ./app_py:/app:ro
    expose:
      - "80"       # was "8000"
    restart: unless-stopped
  app_node:
    image: node:24-alpine
    working_dir: /srv
    entrypoint: sh -c "npm install -g npm@11.7.0 && npm install --omit=dev --no-package-lock && node api.js"
    volumes:
      - ./app_node:/srv              # RW is fine for dev here
      - app_node_node_modules:/srv/node_modules
    expose: ["4000"]
    restart: unless-stopped

# ⬇️ THIS MUST BE TOP-LEVEL, NOT UNDER `services`
volumes:
  index_node_modules:
  app_node_node_modules:
